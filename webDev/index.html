<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Grayscale - Start Bootstrap Theme</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="js/2010_Census_Blocks.js"></script>
        <script src="js/Street_ROW_Trees.js"></script>
        <script src="js/classification_datasets.js"></script>
        <script src="js/merged_pasadena.js"></script>
        <script src="js/census_merged.js"></script>
        <link href="css/greencity.css" rel="stylesheet" />
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>  
    <script src="https://unpkg.com/leaflet-path-drag"></script>
    <script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
     <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script> 

     <!--link href="css/leaflet.css" rel="stylesheet" /-->
        <!--script src="js/leaflet.js"></script-->

        <!--link href="css/map.css" rel="stylesheet" /-->
          <style>
            /*#map { height: 800px; width: 100%; }*/
        </style>  
        
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">

                <a class="navbar-brand" href="#page-top">Green City</a>
                <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="#projects">Projects</a></li>
                        <li class="nav-item"><a class="nav-link" href="#app">App</a></li>
                        <li class="nav-item"><a class="nav-link" href="#signup">Contact</a></li>
                    </ul>
                </div>

        </nav>
        <!-- Masthead-->
        <header class="masthead">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="mx-auto my-0 text-uppercase">GreenCity</h1>
                        <h2 class="text-white-50 mx-auto mt-2 mb-5">Urban Tree Canopy Monitor</h2>
                        <a class="btn btn-primary" href="#about">Get Started</a>
                    </div>
                </div>
            </div>
        </header>
        <!-- About-->
        <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">Built with Bootstrap 5</h2>
                        <p class="text-white-50">
                            Grayscale is a free Bootstrap theme created by Start Bootstrap. It can be yours right now, simply download the template on
                            <a href="https://startbootstrap.com/theme/grayscale/">the preview page.</a>
                            The theme is open source, and you can use it for any purpose, personal or commercial.

                        </p>
                    </div>
                </div>

            </div>
        </section>
        <!-- Projects-->
        

        <section class="bg-light" id="app" height="100%">
            <!-- Featured app Row-->
            <div class="row align-items-center"> 
                
                <div class="featured-text text-center text-lg-left">

                    <div id="map">
                        <div id="sidebar">
                             <div class="sidebarmenu">Tree Detection Model</div>
                             <label><input type="checkbox" name="model" value="training" checked > Training Set</label>
                             <label><input type="checkbox" name="model" value="baseline" > Baseline</label>
                            <label><input type="checkbox" name="model" value="deepforest" >  Deep Forest</label>
                             
                                <hr>
                             <div class="sidebarmenu">Area Selection</div>
                             <label><input type="radio" name="tool" value="blocks" checked> Census Blocks</label>
                            <label><input type="radio" name="tool" value="rectangle" > 100 Acre Box</label>
                            <label><input type="radio" name="tool" value="street" > Street View</label>
                            
                                <hr>

                             <div class="sidebarmenu">Map View</div>
                            <label><input type="radio" name="mapView" value="satellite" checked> Satellite</label>
                            <label><input type="radio" name="mapView" value="streets"> Streets</label>
                            <label><input type="radio" name="mapView" value="terrain"> Terrain</label>
                        </div>
                        <div id="infoBox">Selected Area</div>
                        <div id="legend"></div>
                        <div id="loading">Loading...</div>

                    </div>

<script language="javascript">

// Get map view and map view selection
const baseLayers = {
  satellite: L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: 'Tiles Â© Esri',
      maxZoom: 19 
    }
  ),
  streets: L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19 
    }
  ),
  terrain: L.tileLayer(
    "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      attribution: 'Â© OpenTopoMap contributors',
      maxZoom: 17 // ðŸ‘ˆ prevent requests to non-existent zoom 18+
    }
  )
};
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

window.addEventListener('load', function() {
    document.getElementById('loading').style.display = 'none';
});

const map = L.map("map", {
        center: [34.156113, -118.131943],
        zoom: 13,
        zoomControl: true, 
        editable: true, // Required for Leaflet.Editable
    });

document.querySelectorAll('input[name="mapView"]').forEach(input => {
    input.addEventListener('change', (e) => {
        const selected = e.target.value;

        // Remove all other base layers
        Object.values(baseLayers).forEach(layer => {
        if (map.hasLayer(layer)) {
            map.removeLayer(layer);
        }
        });

        // Add the selected one
        baseLayers[selected].addTo(map);
        if (selected === 'terrain' && map.getZoom() > 17) {
            map.setZoom(17);
  }

    });
});
/*L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    minZoom: 12,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);
*/

let selectionRect = null;     
const infoBox = document.getElementById('infoBox');
boxInfo = {}

function updateInfoBox(feature, selectedPoints, numModel) {
    const areaSqMeters = turf.area(feature);  // Turf requires GeoJSON Feature
    const areaAcres = areaSqMeters / 4046.8564224;
    const hectare = areaAcres / 2.47105 
    //const pointCount = selectedPoints.features.filter(f => f.geometry.type === "Point").length;
    const pointCount = selectedPoints.features.length/numModel;
    //const hectares = acres * 0.404686;
    const density = pointCount / hectare;

    htmlOut = `<h5>Selected Area</h5>`;
    htmlOut += `<div>Area: ${areaAcres.toFixed(0)} Acre</div>`;
    htmlOut += `<div>Model Selected: ${numModel}</div>`;
    htmlOut += `<div>Avg Trees: ${pointCount.toFixed(0)}</div>`;
    htmlOut += `<div>Density: ${density.toFixed(0)}</div>`;
    htmlOut += `<div>Benefits: ...</div>`;
    infoBox.innerHTML = htmlOut;

//How Much CO2 Does A Tree Absorb?
        //average value of 10 kilograms/22 pounds per tree per year
    //https://onetreeplanted.org/blogs/stories/how-much-co2-does-tree-absorb?utm_source=chatgpt.com

    /*
    Tree Density
    City trees per hectare
    https://wfpquantum.s3.amazonaws.com/pdf/2021/63937_State%20of%20the%20Urban%20Forest%20April%202021.pdf?utm_source=chatgpt.com
    
    City trees per hectare
    <â€¯25; 26â€“50; 51-75; 76-100; >100
    */
    
    /*
    Air Quality
    AQI
    https://en.wikipedia.org/wiki/Air_quality_index?utm_source=chatgpt.com
    iâ€‘Tree Eco estimates pollutant removal (PMâ‚‚.â‚…, NOâ‚‚, Oâ‚ƒ, SOâ‚‚, CO), expressed in grams per mÂ² of canopy or kg per hectare per year, using local weather and air data
    
    1 urban tree removes on average:
    0.015 kg (15 g) PMâ‚‚.â‚… per year
    One hectare of U.S.
    urban tree cover averages about 67 kg of pollution removal per year (Nowak
    et al. 2014)
    */
}

/*
 *  Model select base on GeoJson of the tree points against census blocks
 */

 // color of each census block base on tree density
function getDensityColor(d) {
  return d > 25  ? '#0c2e13' :
         d > 20  ? '#0e6920' :
         d > 15  ? '#198a2c':
         d > 10  ? '#29ba3a':
         d > 5   ? '#6af73b' :
         d > 1   ? '#b7fc47':
         d > 0   ? '#fcf347':
                   '#fc9d30';
}

function addLegend() {
  const legend = document.getElementById('legend');
  const grades = [0, 1, 5, 10, 15, 20, 25];

  let html = `<strong>Tree Density <br>in census block<br>(trees/ha)</strong><br><br>`;
  for (let i = grades.length - 1; i >= 0; i--) {
    const from = grades[i];
    const to = grades[i + 1];
    const label = to ? `${from}-${to}` : `> ${from}`;
    html += `
      <div>
        <span style="background:${getDensityColor(from)}"></span>${label}
      </div>`;
  }

  legend.innerHTML = html;
}

addLegend();


function interpolateColor(color1, color2, factor) {
    const c1 = parseInt(color1.slice(1), 16);
    const c2 = parseInt(color2.slice(1), 16);

    const r1 = (c1 >> 16) & 0xff, g1 = (c1 >> 8) & 0xff, b1 = c1 & 0xff;
    const r2 = (c2 >> 16) & 0xff, g2 = (c2 >> 8) & 0xff, b2 = c2 & 0xff;

    const r = Math.round(r1 + factor * (r2 - r1));
    const g = Math.round(g1 + factor * (g2 - g1));
    const b = Math.round(b1 + factor * (b2 - b1));

    return `rgb(${r}, ${g}, ${b})`;
}

function ShapeOptions(feature) {
  const density = feature.properties.density || 0; // if already computed
  //alert(density);
    //const factor = (3 - 1) / (26 - 1);
  return {
    
    fillColor: getDensityColor(density),
    //fillColor: interpolateColor('#0d3614', '#c98422', factor),
    weight: 1,
    color: "#888",
    fillOpacity: 0.5
  };
}

const hoverStyle = {
    color: "#fff",
    weight: 3,
    fillOpacity: 0.5
};

const clickBorderStyle = {
    weight: 2,
    color: "#fff", 
    fillOpacity: 0.5
};

const treeBox = {
    color: "#fff",
    weight: 1,
    fillOpacity: 0.1
};


let toolon = "blocks"; // default
let polygonLayer = null;
let selectedLayer = null; // Track clicked layer
let selectedBlockFeature = null;
const activeModels = new Set();

const modelData = {
    "baseline": {
        polygon: census_blocks_with_prediction,
        trees: prediction_trees,
        type: "pt",
        color: "#f7b283",
        size: 3,
        layer: null  // add this!
    },
    "training": {
        polygon: census_blocks_with_street,
        trees: street_row_trees,
        type: "pt",
        size: 3,
        color: "#7dc7ff",
        layer: null
    },
    "deepforest": {
        polygon: census_blocks_deep_forest,
        trees: deep_forest,
        type: "box",
        size: 2,
        color: "#f3f7cb",
        layer: null
    }
};

function createCircleMarker(feature, latlng) {
    const model = feature.properties.model;
    const modelStyle = modelData[model];

    const size = modelStyle.size || 2;
    const color = modelStyle.color || "#cccccc";

    return L.circleMarker(latlng, {
        radius: size,
        fillColor: color,
        color: "#333333",
        weight: 0.5,
        opacity: 1,
        fillOpacity: 1
    });
}
                     
function removeCircleMarker(){
    map.eachLayer(function (l) {
        if (l instanceof L.CircleMarker) {
            map.removeLayer(l);
        }
    });
}

function showTrees(blockFeature) {
    // Only run if current tool is "blocks" and block is selected
    if (toolon !== "blocks" || !selectedLayer) {
        return;
    }

    // Remove all previous filtered layers for active models
    activeModels.forEach(model => {
        const data = modelData[model];
        if (data.layer && map.hasLayer(data.layer)) {
            map.removeLayer(data.layer);
            data.layer = null;
        }
    });


    // If no models are active, don't draw anything
    if (activeModels.size === 0) return;

    const blockPolygon = turf.feature(blockFeature.geometry);

    let combinedFeatures = []; 

    activeModels.forEach(model => {
        const data = modelData[model];
        if (!data || !data.trees) return;

        let filteredGeoJSON = null;

        if (data.type === "pt") {
            const filtered = turf.pointsWithinPolygon(data.trees, blockPolygon);
            if (filtered.features.length === 0) return;

            // Inject model name
            filtered.features.forEach(f => {
                f.properties.model = model;
            });

            filteredGeoJSON = filtered;

            data.layer = L.geoJSON(filteredGeoJSON, {
                pointToLayer: createCircleMarker
            }).addTo(map);

        } else if (data.type === "box") {
            const centroids = {
                type: "FeatureCollection",
                features: data.trees.features.map(feature => {
                    const center = turf.centroid(feature);
                    center.properties.parent = feature;
                    return center;
                })
            };

            const filteredPoints = turf.pointsWithinPolygon(centroids, blockPolygon);
            if (filteredPoints.features.length === 0) return;

            const filteredPolygons = {
                type: "FeatureCollection",
                features: filteredPoints.features.map(f => {
                    const poly = f.properties.parent;
                    poly.properties.model = model;  // Inject model here
                    return poly;
                })
            };


            filteredGeoJSON = filteredPolygons;

            data.layer = L.geoJSON(filteredGeoJSON, {
                style: function(feature) {
                    const model = feature.properties.model;
                    const modelStyle = modelData[model];
                    return {
                        color: modelStyle.color,
                        weight: modelStyle.size || 2,
                        fillOpacity: 0.1
                    };
                }
            }).addTo(map);
        }// if box
        combinedFeatures = combinedFeatures.concat(filteredGeoJSON.features);
        
    });


    const combinedFeatureCollection = {
        type: "FeatureCollection",
        features: combinedFeatures
    };

    updateInfoBox(blockFeature, combinedFeatureCollection, activeModels.size);
}


polygonLayer = L.geoJSON(modelData["training"].polygon, {
    style: ShapeOptions,
    onEachFeature: (feature, layer) => {
        layer.on('click', () => {
            if (toolon !== "blocks") return;

            if (selectedLayer && selectedLayer !== layer) {
                selectedLayer.setStyle(ShapeOptions(selectedLayer.feature));
            }

            layer.setStyle(clickBorderStyle);
            selectedLayer = layer;
            selectedBlockFeature = feature;

            showTrees(feature);  // only show trees on click
        });

        layer.on('mouseover', () => {
            if (toolon !== "blocks") return;
            if (layer !== selectedLayer) {
                layer.setStyle(hoverStyle)
            }
        });

        layer.on('mouseout', () => {
            if (toolon !== "blocks") return;
            if (layer !== selectedLayer) {
                layer.setStyle(ShapeOptions(feature));
            }
        });
    }
}).addTo(map);

function updatePolygonStyle() {
    const numModels = activeModels.size;
    if (numModels === 0) {
        // No models selected, reset styles
        polygonLayer.setStyle(ShapeOptions);
        return;
    }

    const baseFeatures = polygonLayer.toGeoJSON().features;

    // Update densities by averaging across models for each polygon by index
    baseFeatures.forEach((feature, i) => {
        let totalDensity = 0;

        activeModels.forEach(model => {
        const modelFeatures = modelData[model].polygon.features;
        if (modelFeatures && modelFeatures[i]) {
            const d = modelFeatures[i].properties.density || 0;
            totalDensity += d;
        }
        });

        feature.properties.density = totalDensity / numModels;
    });

    // Now update style for all layers inside polygonLayer
    polygonLayer.setStyle((feature) => {
        // Find index of this feature to get updated density
        const index = polygonLayer.getLayers().findIndex(l => l.feature === feature);
        if (index >= 0) {
        return ShapeOptions(baseFeatures[index]);
        }
        // fallback
        return ShapeOptions(feature);
    });
}

function updateVisiblePoints() {
    if (!selectionRect || (toolon !== "rectangle" && toolon !== "street")) {
        // No selection rectangle or wrong tool
        activeModels.forEach(model => {
            const data = modelData[model];
            if (data.layer && map.hasLayer(data.layer)) {
                map.removeLayer(data.layer);
                data.layer = null;
            }
        });
        return;
    }

    const rectBounds = selectionRect.getBounds();
    const turfPoly = turf.polygon([[
        [rectBounds.getWest(), rectBounds.getSouth()],
        [rectBounds.getEast(), rectBounds.getSouth()],
        [rectBounds.getEast(), rectBounds.getNorth()],
        [rectBounds.getWest(), rectBounds.getNorth()],
        [rectBounds.getWest(), rectBounds.getSouth()]
    ]]);

    // Remove previous layers
    activeModels.forEach(model => {
        const data = modelData[model];
        if (data.layer && map.hasLayer(data.layer)) {
            map.removeLayer(data.layer);
            data.layer = null;
        }
    });

    if (activeModels.size === 0) return;

    let combinedFeatures = [];  // top of function
    activeModels.forEach(model => {
        const data = modelData[model];
        if (!data || !data.trees) return;

        let filteredGeoJSON = null;

        if (data.type === "pt") {
            const filtered = {
                type: "FeatureCollection",
                features: data.trees.features.filter(pt =>
                    turf.booleanPointInPolygon(pt, turfPoly)
                )
            };

            if (filtered.features.length === 0) return;

            filtered.features.forEach(f => {
                f.properties.model = model;
            });

            filteredGeoJSON = filtered;

            data.layer = L.geoJSON(filteredGeoJSON, {
                pointToLayer: createCircleMarker
            }).addTo(map);

        } else if (data.type === "box") {
            const centroids = {
                type: "FeatureCollection",
                features: data.trees.features.map(feature => {
                    const center = turf.centroid(feature);
                    center.properties.parent = feature;
                    return center;
                })
            };

            const filteredPoints = turf.pointsWithinPolygon(centroids, turfPoly);
            if (filteredPoints.features.length === 0) return;

            const filteredPolygons = {
                type: "FeatureCollection",
                features: filteredPoints.features.map(f => {
                    const poly = f.properties.parent;
                    poly.properties.model = model;
                    return poly;
                })
            };

            filteredGeoJSON = filteredPolygons;

            data.layer = L.geoJSON(filteredGeoJSON, {
                style: function(feature) {
                    const model = feature.properties.model;
                    const modelStyle = modelData[model];
                    return {
                        color: modelStyle.color,
                        weight: modelStyle.size || 2,
                        fillOpacity: 0.1
                    };
                }
            }).addTo(map);
        }// if box
        combinedFeatures = combinedFeatures.concat(filteredGeoJSON.features);

    });
    const combinedFeatureCollection = {
        type: "FeatureCollection",
        features: combinedFeatures
    };

    updateInfoBox(turfPoly, combinedFeatureCollection, activeModels.size);
}

    

function genMapViewRect() {
    if (selectionRect) {
        map.removeLayer(selectionRect);
    }
    const bounds = map.getBounds();
    selectionRect = L.rectangle(bounds); // Not added to map
}

const MAX_WIDTH = 0.02;  // degrees
const MAX_HEIGHT = 0.02; // degrees

function genRec(center) {
    const offsetLat = 0.00286;  // â‰ˆ 317 meters
    const offsetLng = 0.00345;  // â‰ˆ 317 meters

    const bounds = L.latLngBounds(
        [center.lat - offsetLat, center.lng - offsetLng],
        [center.lat + offsetLat, center.lng + offsetLng]
    );

    // Update existing rectangle
    if (selectionRect) {
        selectionRect.setBounds(bounds);
    } else {
        selectionRect = L.rectangle(bounds, {
            color: '#fff',
            weight: 3,
            fillOpacity: 0.1,
            draggable: true
        }).addTo(map);

        selectionRect.dragging.enable();
        selectionRect.on('dragend', () => {updateVisiblePoints();});
        selectionRect.on("editable:dragend", updateVisiblePoints);

        // Minimal fallback:
        map.on("zoomend", updateVisiblePoints); // Update on zoom if dragging isn't available
    }
}
function onMapMoveOrZoom() {
    genMapViewRect();
    updateVisiblePoints();
}

function waitForZoomThenRun(targetZoom, callback) {
  if (map.getZoom() !== targetZoom) {
    map.once("zoomend", callback);
    map.setZoom(targetZoom);
  } else {
    callback(); // already at target zoom, just run it
  }
}

function onMapClickRectangle(e) {
    if (toolon !== "rectangle") return;

    const sidebar = document.getElementById('sidebar');
    if (sidebar && sidebar.contains(e.originalEvent.target)) {
        // Click was inside sidebar â€” ignore
        return;
    }

    const center = e.latlng;
    genRec(center);
    updateVisiblePoints();
}

function handleToolChange(tool) {
    removeCircleMarker();
    toolon = tool
    // Remove existing rectangle
    if (selectionRect) {
        map.removeLayer(selectionRect);
        selectionRect = null;
    }

    // Remove old click handler
    map.off("zoomend", onMapMoveOrZoom);
    map.off("moveend", onMapMoveOrZoom);

    if (toolon !== "blocks" && selectedLayer) {
        selectedLayer.setStyle(ShapeOptions(selectedLayer.feature));
        selectedLayer = null;
    }

    if (tool === 'blocks') {
        const center = [34.156113, -118.131943];
        map.zoomControl.enable(); 
        map.options.minZoom = 0;
        map.options.maxZoom = 24;
        map.on("zoomend", () => {
        if (toolon === "blocks" && selectedLayer) {
                showTrees(selectedLayer.feature);
            }
        });

        map.on("moveend", () => {
            if (toolon === "blocks" && selectedLayer) {
                showTrees(selectedLayer.feature);
            }
        });
        //map.setView(center, 13);
        updateVisiblePoints()
    } 
    else if (tool === 'rectangle') {
        map.setZoom(15);
        map.zoomControl.enable();
        map.options.minZoom = 0;
        map.options.maxZoom = 24;

        const center = map.getCenter();
        genRec(center);
        updateVisiblePoints();

        // Remove any previous zoom listener and re-add
        map.off("zoomend", updateVisiblePoints);
        map.on("zoomend", updateVisiblePoints);

        // Remove any previous click listener for rectangle tool and re-add
        map.off("click", onMapClickRectangle);
        map.on("click", onMapClickRectangle);
    }
    else if (tool === "street") {
        const fixedZoom = 18;
        map.zoomControl.disable();
        map.options.minZoom = fixedZoom;
        map.options.maxZoom = fixedZoom;

        waitForZoomThenRun(fixedZoom, () => {
            genMapViewRect();         // now safe to generate selection
            onMapMoveOrZoom();        // update visible points
            map.on("moveend", onMapMoveOrZoom); // bind dynamic update
        });
    }

    if (tool === 'blocks' && selectedBlockFeature) {
        showTrees(selectedBlockFeature); // re-render tree points inside block
    }

}


function addModelLayer(model) {
    const data = modelData[model];
    if (!data) return;

    if (activeModels.has(model)) return;

    activeModels.add(model);

    // If current tool is "blocks" and a block is selected, update trees
    if (toolon === "blocks" && selectedLayer) {
        showTrees(selectedLayer.feature);
    }
    updatePolygonStyle()
}

function removeModelLayer(model) {
    const data = modelData[model];
    if (!data) return;

    activeModels.delete(model);

    if (data.layer && map.hasLayer(data.layer)) {
        map.removeLayer(data.layer);
        data.layer = null;
    }

    // If current tool is "blocks" and a block is selected, update trees
    if (toolon === "blocks" && selectedLayer) {
        showTrees(selectedLayer.feature);
    }
    updatePolygonStyle()
}
// Automatically toggle when radio button changes
document.querySelectorAll('input[name="tool"]').forEach(input => {
input.addEventListener('change', (e) => {
        handleToolChange(e.target.value);
    });
});


// Trigger default on load and initialize all variables
                    
window.addEventListener('DOMContentLoaded', () => {
    const groups = ['model', 'tool', 'mapView'];

    groups.forEach(name => {
        const radios = document.querySelectorAll(`input[name="${name}"]`);
        radios.forEach(radio => (radio.checked = false)); // Clear all first

        // Find the one with checked attribute in HTML and set checked true to force sync
        const defaultRadio = document.querySelector(`input[name="${name}"][checked]`);
        if (defaultRadio) {
            defaultRadio.checked = true;
        }
    });
    
    // Load initial dataset
    map.setZoom(13);
    baseLayers.satellite.addTo(map); // default view
    }
);

document.querySelectorAll('input[name="model"]').forEach(cb => {
    cb.addEventListener('change', function() {
        const model = this.value;
        if (this.checked) {
            addModelLayer(model);
        } else {
            removeModelLayer(model);
        }   
        // Update visible points if tool is rectangle or street
        if (toolon === "rectangle" || toolon === "street") {
            updateVisiblePoints();
        }
        // Also handle blocks tool if needed
        if (toolon === "blocks" && selectedBlockFeature) {
            showTrees(selectedBlockFeature);
        }
    });
});

document.querySelector('input[name="model"][value="training"]').checked = true;
addModelLayer("training");

handleToolChange(document.querySelector('input[name="tool"]:checked').value);

                
                    </script>   


                </div>
            </div>        

        </section>
        <!-- Map-->
        <section class="projects-section bg-light" id="projects">
            <div class="container px-4 px-lg-5">
                <!-- Featured Project Row-->
                <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
                    <div class="col-xl-8 col-lg-7"><img class="img-fluid mb-3 mb-lg-0" src="assets/img/bg-masthead.jpg" alt="..." /></div>
                    <div class="col-xl-4 col-lg-5">
                        <div class="featured-text text-center text-lg-left">
                            <h4>Shoreline</h4>
                            <p class="text-black-50 mb-0">Grayscale is open source and MIT licensed. This means you can use it for any project - even commercial projects! Download it, customize it, and publish your website!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Project One Row-->
                <div class="row gx-0 mb-5 mb-lg-0 justify-content-center">
                    <div class="col-lg-6"><img class="img-fluid" src="assets/img/demo-image-01.jpg" alt="..." /></div>
                    <div class="col-lg-6">
                        <div class="bg-black text-center h-100 project">
                            <div class="d-flex h-100">
                                <div class="project-text w-100 my-auto text-center text-lg-left">
                                    <h4 class="text-white">Misty</h4>
                                    <p class="mb-0 text-white-50">An example of where you can put an image of a project, or anything else, along with a description.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Project Two Row-->
                <div class="row gx-0 justify-content-center">
                    <div class="col-lg-6"><img class="img-fluid" src="assets/img/demo-image-02.jpg" alt="..." /></div>
                    <div class="col-lg-6 order-lg-first">
                        <div class="bg-black text-center h-100 project">
                            <div class="d-flex h-100">
                                <div class="project-text w-100 my-auto text-center text-lg-right">
                                    <h4 class="text-white">Mountains</h4>
                                    <p class="mb-0 text-white-50">Another example of a project with its respective description. These sections work well responsively as well!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Signup-->
        <section class="signup-section" id="signup">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5">
                    <div class="col-md-10 col-lg-8 mx-auto text-center">
                        <i class="far fa-paper-plane fa-2x mb-2 text-white"></i>
                        <h2 class="text-white mb-5">Subscribe to receive updates!</h2>
                        <!-- * * * * * * * * * * * * * * *-->
                        <!-- * * SB Forms Contact Form * *-->
                        <!-- * * * * * * * * * * * * * * *-->
                        <!-- This form is pre-integrated with SB Forms.-->
                        <!-- To make this form functional, sign up at-->
                        <!-- https://startbootstrap.com/solution/contact-forms-->
                        <!-- to get an API token!-->
                        <form class="form-signup" id="contactForm" data-sb-form-api-token="API_TOKEN">
                            <!-- Email address input-->
                            <div class="row input-group-newsletter">
                                <div class="col"><input class="form-control" id="emailAddress" type="email" placeholder="Enter email address..." aria-label="Enter email address..." data-sb-validations="required,email" /></div>
                                <div class="col-auto"><button class="btn btn-primary disabled" id="submitButton" type="submit">Notify Me!</button></div>
                            </div>
                            <div class="invalid-feedback mt-2" data-sb-feedback="emailAddress:required">An email is required.</div>
                            <div class="invalid-feedback mt-2" data-sb-feedback="emailAddress:email">Email is not valid.</div>
                            <!-- Submit success message-->
                            <!---->
                            <!-- This is what your users will see when the form-->
                            <!-- has successfully submitted-->
                            <div class="d-none" id="submitSuccessMessage">
                                <div class="text-center mb-3 mt-2 text-white">
                                    <div class="fw-bolder">Form submission successful!</div>
                                    To activate this form, sign up at
                                    <br />
                                    <a href="https://startbootstrap.com/solution/contact-forms">https://startbootstrap.com/solution/contact-forms</a>
                                </div>
                            </div>
                            <!-- Submit error message-->
                            <!---->
                            <!-- This is what your users will see when there is-->
                            <!-- an error submitting the form-->
                            <div class="d-none" id="submitErrorMessage"><div class="text-center text-danger mb-3 mt-2">Error sending message!</div></div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        <!-- Contact-->
        <section class="contact-section bg-black">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card py-4 h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-map-marked-alt text-primary mb-2"></i>
                                <h4 class="text-uppercase m-0">Address</h4>
                                <hr class="my-4 mx-auto" />
                                <div class="small text-black-50">4923 Market Street, Orlando FL</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card py-4 h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-envelope text-primary mb-2"></i>
                                <h4 class="text-uppercase m-0">Email</h4>
                                <hr class="my-4 mx-auto" />
                                <div class="small text-black-50"><a href="#!">hello@yourdomain.com</a></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card py-4 h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-mobile-alt text-primary mb-2"></i>
                                <h4 class="text-uppercase m-0">Phone</h4>
                                <hr class="my-4 mx-auto" />
                                <div class="small text-black-50">+1 (555) 902-8832</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="social d-flex justify-content-center">
                    <a class="mx-2" href="#!"><i class="fab fa-twitter"></i></a>
                    <a class="mx-2" href="#!"><i class="fab fa-facebook-f"></i></a>
                    <a class="mx-2" href="#!"><i class="fab fa-github"></i></a>
                </div>
            </div>
        </section>
        <!-- Footer-->
        <footer class="footer bg-black small text-center text-white-50"><div class="container px-4 px-lg-5">Copyright &copy; Your Website 2023</div></footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <!-- * *                               SB Forms JS                               * *-->
        <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    </body>
</html>
